import { Psalm, Refrain } from '../src';

const PSALM_107 = {
  slug: 'psalm_107_i',
  category: ['Psalm'],
  metadata: {
    omit_antiphon: false,
    localname: 'Psalm 107: Part I',
    latinname: 'Confitemini Domino',
    omit_gloria: false,
    number: '107',
  },
  version_label: null,
  source: {
    citation: 'p. 746',
    source: 'bcp1979',
    api: 'https://www.venite.app/api',
  },
  type: 'psalm',
  version: 'bcp1979',
  value: [
    {
      type: 'psalm-section',
      value: [
        {
          halfverse: 'and his mercy endures for ever.',
          type: 'psalm-verse',
          number: '1',
          verse: 'Give thanks to the LORD, for he is good, *',
        },
        {
          number: '2',
          verse: 'Let all those whom the LORD has redeemed proclaim *',
          halfverse: 'that he redeemed them from the hand of the foe.',
          type: 'psalm-verse',
        },
        {
          type: 'psalm-verse',
          number: '3',
          halfverse: 'from the east and from the west,\n from the north and from the south.',
          verse: 'He gathered them out of the lands; *',
        },
        {
          halfverse: 'they found no way to a city where they might dwell.',
          type: 'psalm-verse',
          verse: 'Some wandered in desert wastes; *',
          number: '4',
        },
        {
          type: 'psalm-verse',
          verse: 'They were hungry and thirsty; *',
          number: '5',
          halfverse: 'their spirits languished within them.',
        },
        {
          halfverse: 'and he delivered them from their distress.',
          number: '6',
          type: 'psalm-verse',
          verse: 'Then they cried to the LORD in their trouble, *',
        },
        {
          number: '7',
          type: 'psalm-verse',
          halfverse: 'to go to a city where they might dwell.',
          verse: 'He put their feet on a straight path *',
        },
        {
          halfverse: 'and the wonders he does for his children.',
          verse: 'Let them give thanks to the LORD for his mercy *',
          number: '8',
          type: 'psalm-verse',
        },
        {
          halfverse: 'and fills the hungry with good things.',
          verse: 'For he satisfies the thirsty *',
          type: 'psalm-verse',
          number: '9',
        },
        {
          verse: 'Some sat in darkness and deep gloom, *',
          type: 'psalm-verse',
          number: '10',
          halfverse: 'bound fast in misery and iron;',
        },
        {
          type: 'psalm-verse',
          verse: 'Because they rebelled against the words of God *',
          halfverse: 'and despised the counsel of the Most High.',
          number: '11',
        },
        {
          halfverse: 'they stumbled, and there was none to help.',
          number: '12',
          verse: 'So he humbled their spirits with hard labor; *',
          type: 'psalm-verse',
        },
        {
          type: 'psalm-verse',
          number: '13',
          halfverse: 'and he delivered them from their distress.',
          verse: 'Then they cried to the LORD in their trouble, *',
        },
        {
          number: '14',
          verse: 'He led them out of darkness and deep gloom *',
          halfverse: 'and broke their bonds asunder.',
          type: 'psalm-verse',
        },
        {
          verse: 'Let them give thanks to the LORD for his mercy *',
          number: '15',
          halfverse: 'and the wonders he does for his children.',
          type: 'psalm-verse',
        },
        {
          verse: 'For he shatters the doors of bronze *',
          type: 'psalm-verse',
          number: '16',
          halfverse: 'and breaks in two the iron bars.',
        },
        {
          type: 'psalm-verse',
          number: '17',
          halfverse: 'they were afflicted because of their sins.',
          verse: 'Some were fools and took to rebellious ways; *',
        },
        {
          type: 'psalm-verse',
          verse: 'They abhorred all manner of food *',
          halfverse: 'and drew near to death’s door.',
          number: '18',
        },
        {
          number: '19',
          type: 'psalm-verse',
          verse: 'Then they cried to the LORD in their trouble, *',
          halfverse: 'and he delivered them from their distress.',
        },
        {
          number: '20',
          type: 'psalm-verse',
          halfverse: 'and saved them from the grave.',
          verse: 'He sent forth his word and healed them *',
        },
        {
          verse: 'Let them give thanks to the LORD for his mercy *',
          number: '21',
          type: 'psalm-verse',
          halfverse: 'and the wonders he does for his children.',
        },
        {
          verse: 'Let them offer a sacrifice of thanksgiving *',
          number: '22',
          halfverse: 'and tell of his acts with shouts of joy.',
          type: 'psalm-verse',
        },
        {
          halfverse: 'and plied their trade in deep waters;',
          number: '23',
          type: 'psalm-verse',
          verse: 'Some went down to the sea in ships *',
        },
        {
          number: '24',
          type: 'psalm-verse',
          halfverse: 'and his wonders in the deep.',
          verse: 'They beheld the works of the LORD *',
        },
        {
          number: '25',
          type: 'psalm-verse',
          halfverse: 'which tossed high the waves of the sea.',
          verse: 'Then he spoke, and a stormy wind arose, *',
        },
        {
          verse: 'They mounted up to the heavens and fell back to the depths; *',
          number: '26',
          halfverse: 'their hearts melted because of their peril.',
          type: 'psalm-verse',
        },
        {
          halfverse: 'and were at their wits’ end.',
          number: '27',
          verse: 'They reeled and staggered like drunkards *',
          type: 'psalm-verse',
        },
        {
          verse: 'Then they cried to the LORD in their trouble, *',
          halfverse: 'and he delivered them from their distress.',
          number: '28',
          type: 'psalm-verse',
        },
        {
          halfverse: 'and quieted the waves of the sea.',
          verse: 'He stilled the storm to a whisper *',
          number: '29',
          type: 'psalm-verse',
        },
        {
          number: '30',
          type: 'psalm-verse',
          verse: 'Then were they glad because of the calm, *',
          halfverse: 'and he brought them to the harbor they were bound for.',
        },
        {
          halfverse: 'and the wonders he does for his children.',
          type: 'psalm-verse',
          number: '31',
          verse: 'Let them give thanks to the LORD for his mercy *',
        },
        {
          verse: 'Let them exalt him in the congregation of the people *',
          number: '32',
          halfverse: 'and praise him in the council of the elders.',
          type: 'psalm-verse',
        },
      ],
    },
    {
      type: 'psalm-section',
      value: [
        {
          verse: 'The LORD changed rivers into deserts, *',
          halfverse: 'and water-springs into thirsty ground,',
          number: '33',
          type: 'psalm-verse',
        },
        {
          number: '34',
          type: 'psalm-verse',
          halfverse: 'because of the wickedness of those who dwell there.',
          verse: 'A fruitful land into salt flats, *',
        },
        {
          number: '35',
          verse: 'He changed deserts into pools of water *',
          type: 'psalm-verse',
          halfverse: 'and dry land into water-springs.',
        },
        {
          type: 'psalm-verse',
          verse: 'He settled the hungry there, *',
          number: '36',
          halfverse: 'and they founded a city to dwell in.',
        },
        {
          halfverse: 'and brought in a fruitful harvest.',
          verse: 'They sowed fields, and planted vineyards, *',
          number: '37',
          type: 'psalm-verse',
        },
        {
          number: '38',
          type: 'psalm-verse',
          halfverse: 'he did not let their herds decrease.',
          verse: 'He blessed them, so that they increased greatly; *',
        },
        {
          type: 'psalm-verse',
          verse: 'Yet when they were diminished and brought low, *',
          halfverse: 'through stress of adversity and sorrow,',
          number: '39',
        },
        {
          verse: '(He pours contempt on princes *',
          number: '40',
          halfverse: 'and makes them wander in trackless wastes)',
          type: 'psalm-verse',
        },
        {
          number: '41',
          verse: 'He lifted up the poor out of misery *',
          halfverse: 'and multiplied their families like flocks of sheep.',
          type: 'psalm-verse',
        },
        {
          halfverse: 'but all wickedness will shut its mouth.',
          type: 'psalm-verse',
          number: '42',
          verse: 'The upright will see this and rejoice, *',
        },
        {
          verse: 'Whoever is wise will ponder these things, *',
          number: '43',
          halfverse: 'and consider well the mercies of the LORD.',
          type: 'psalm-verse',
        },
      ],
    },
  ],
  style: 'psalm',
  label: 'Psalm 107: Part I',
  language: 'en',
  hidden: false,
  citation: null,
};

const PSALM_80 = {
  api: '',
  slug: 'psalm_80',
  label: 'Psalm 80',
  language: 'en',
  version: 'bcp1979',
  type: 'psalm' as 'psalm',
  style: 'psalm' as 'psalm',
  citation: 'Psalm 80',
  value: [
    {
      type: 'psalm-section' as 'psalm-section',
      value: [
        {
          type: 'psalm-verse' as 'psalm-verse',
          number: '1',
          verse: 'Hear, O Shepherd of Israel, leading Joseph like a flock; * ',
          halfverse: 'shine forth, you that are enthroned upon the cherubim.',
        },
        {
          type: 'psalm-verse' as 'psalm-verse',
          number: '2',
          verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
          halfverse: 'stir up your strength and come to help us.',
        },
        {
          type: 'psalm-verse' as 'psalm-verse',
          number: '3',
          verse: 'Restore us, O God of hosts; *',
          halfverse: 'show the light of your countenance, and we shall be saved.',
        },
      ],
    },
  ],
};

const PSALM_3_BUT_REALLY_ITS_80 = {
  api: '',
  slug: 'psalm_3',
  label: 'Psalm 3',
  language: 'en',
  version: 'bcp1979',
  type: 'psalm' as 'psalm',
  style: 'psalm' as 'psalm',
  citation: 'Psalm 3',
  value: [
    {
      type: 'psalm-section' as 'psalm-section',
      value: [
        {
          type: 'psalm-verse' as 'psalm-verse',
          number: '1',
          verse: 'Hear, O Shepherd of Israel, leading Joseph like a flock; * ',
          halfverse: 'shine forth, you that are enthroned upon the cherubim.',
        },
        {
          type: 'psalm-verse' as 'psalm-verse',
          number: '2',
          verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
          halfverse: 'stir up your strength and come to help us.',
        },
        {
          type: 'psalm-verse' as 'psalm-verse',
          number: '3',
          verse: 'Restore us, O God of hosts; *',
          halfverse: 'show the light of your countenance, and we shall be saved.',
        },
      ],
    },
  ],
};

describe('Psalm.versesInCitation()', () => {
  it('should parse a single verse', () => {
    const psalm = new Psalm(PSALM_80);
    const verses = psalm.versesInCitation('Psalm 80:2');

    expect(verses).toEqual(['2']);
  });

  it('should parse a simple verse range', () => {
    const psalm = new Psalm(PSALM_80);
    const verses = psalm.versesInCitation('Psalm 80:2-4');

    expect(verses).toEqual(['2', '3', '4']);
  });

  it("should parse a single comma'ed verse", () => {
    const psalm = new Psalm(PSALM_80);
    const verses = psalm.versesInCitation('Psalm 80:2-4, 6');

    expect(verses).toEqual(['2', '3', '4', '6']);
  });

  it("should parse comma'ed ranges", () => {
    const psalm = new Psalm(PSALM_80);
    const verses = psalm.versesInCitation('Psalm 80:2-4,6-11');

    expect(verses).toEqual(['2', '3', '4', '6', '7', '8', '9', '10', '11']);
  });

  it('should parse verse numbers with letters included', () => {
    const psalm = new Psalm(PSALM_80);
    const verses = psalm.versesInCitation('Psalm 80:2-4a');

    expect(verses).toEqual(['2', '3', '4']);
  });

  it('should handle verse ranges', () => {
    const psalm = new Psalm(PSALM_107 as Psalm);
    const verses = psalm.versesInCitation('Psalm 107:1-3, 23-25');
    expect(verses).toEqual(['1', '2', '3', '23', '24', '25']);
  });

  it('should add brackets for bracketed citations', () => {
    const psalm = new Psalm(PSALM_107 as Psalm);
    const verses = psalm.versesInCitation('Psalm 107:1-3[4-6]7-8');
    expect(verses).toEqual(['1', '2', '3', '[4', '5', '6]', '7', '8']);
  });

  it('should add brackets for bracketed citations', () => {
    const psalm = new Psalm(PSALM_107 as Psalm);
    const verses = psalm.versesInCitation('Psalm 107:1-2[3]');
    expect(verses).toEqual(['1', '2', '[3]']);
  });
});

describe('Psalm.filteredVerses()', () => {
  it('should give all verses if no explicit citation given', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.citation = 'Psalm 80';
    const verses = psalm.filteredVerses();

    expect(verses).toEqual([
      {
        type: 'psalm-section' as 'psalm-section',
        value: [
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '1',
            verse: 'Hear, O Shepherd of Israel, leading Joseph like a flock; * ',
            halfverse: 'shine forth, you that are enthroned upon the cherubim.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '2',
            verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
            halfverse: 'stir up your strength and come to help us.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '3',
            verse: 'Restore us, O God of hosts; *',
            halfverse: 'show the light of your countenance, and we shall be saved.',
          },
        ],
      },
    ]);
  });

  it('should insert brackets for bracketed citations', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.citation = 'Psalm 80:1-2[3]';
    const verses = psalm.filteredVerses();

    expect(verses).toEqual([
      {
        type: 'psalm-section' as 'psalm-section',
        value: [
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '1',
            verse: 'Hear, O Shepherd of Israel, leading Joseph like a flock; * ',
            halfverse: 'shine forth, you that are enthroned upon the cherubim.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '2',
            verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
            halfverse: 'stir up your strength and come to help us.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '3',
            verse: '[Restore us, O God of hosts; *',
            halfverse: 'show the light of your countenance, and we shall be saved.]',
          },
        ],
      },
    ]);
  });

  it('should ignore the chapter number and use only the verse numbers', () => {
    const psalm = new Psalm(PSALM_3_BUT_REALLY_ITS_80);
    psalm.citation = 'Psalm 3:1-2';
    const verses = psalm.filteredVerses();

    expect(verses).toEqual([
      {
        type: 'psalm-section' as 'psalm-section',
        value: [
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '1',
            verse: 'Hear, O Shepherd of Israel, leading Joseph like a flock; * ',
            halfverse: 'shine forth, you that are enthroned upon the cherubim.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '2',
            verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
            halfverse: 'stir up your strength and come to help us.',
          },
        ],
      },
    ]);
  });

  it('should handle a variety of book name formats', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.citation = 'Ps. 80';
    const verses = psalm.filteredVerses();

    expect(verses).toEqual([
      {
        type: 'psalm-section' as 'psalm-section',
        value: [
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '1',
            verse: 'Hear, O Shepherd of Israel, leading Joseph like a flock; * ',
            halfverse: 'shine forth, you that are enthroned upon the cherubim.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '2',
            verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
            halfverse: 'stir up your strength and come to help us.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '3',
            verse: 'Restore us, O God of hosts; *',
            halfverse: 'show the light of your countenance, and we shall be saved.',
          },
        ],
      },
    ]);
  });

  it('should handle a variety of book name formats', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.citation = 'Psa 80';
    const verses = psalm.filteredVerses();

    expect(verses).toEqual([
      {
        type: 'psalm-section' as 'psalm-section',
        value: [
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '1',
            verse: 'Hear, O Shepherd of Israel, leading Joseph like a flock; * ',
            halfverse: 'shine forth, you that are enthroned upon the cherubim.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '2',
            verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
            halfverse: 'stir up your strength and come to help us.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '3',
            verse: 'Restore us, O God of hosts; *',
            halfverse: 'show the light of your countenance, and we shall be saved.',
          },
        ],
      },
    ]);
  });

  it('should give one verse if one verse cited', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.citation = 'Psalm 80:2';
    const verses = psalm.filteredVerses();

    expect(verses).toEqual([
      {
        type: 'psalm-section' as 'psalm-section',
        value: [
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '2',
            verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
            halfverse: 'stir up your strength and come to help us.',
          },
        ],
      },
    ]);
  });

  it('should support -end in psalm citations', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.citation = 'Psalm 80:2-end';
    const verses = psalm.filteredVerses();

    expect(verses).toEqual([
      {
        type: 'psalm-section' as 'psalm-section',
        value: [
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '2',
            verse: 'In the presence of Ephraim, Benjamin, and Manasseh, *',
            halfverse: 'stir up your strength and come to help us.',
          },
          {
            type: 'psalm-verse' as 'psalm-verse',
            number: '3',
            verse: 'Restore us, O God of hosts; *',
            halfverse: 'show the light of your countenance, and we shall be saved.',
          },
        ],
      },
    ]);
  });

  it("should not include antiphon if there's no antiphon", () => {
    const psalm = new Psalm(PSALM_80);
    expect(psalm.includeAntiphon()).toEqual(false);
  });

  it("should include antiphon if there's an antiphon", () => {
    const psalm = new Psalm(PSALM_80);
    psalm.metadata = {
      antiphon: 'Test antiphon',
    };
    expect(psalm.includeAntiphon()).toEqual(true);
  });

  it('should not include antiphon if omit_antiphon == true', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.metadata = {
      antiphon: 'Test antiphon',
      omit_antiphon: true,
    };
    expect(psalm.includeAntiphon()).toEqual(false);
  });

  it('should include antiphons on canticles', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.style = 'canticle';
    psalm.metadata = {
      antiphon: 'Test antiphon',
    };
    expect(psalm.includeAntiphon()).toEqual(true);
  });

  it('should include repeat antiphons after first set of invitatory', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.style = 'invitatory';
    psalm.metadata = {
      antiphon: 'Test antiphon',
    };
    expect(psalm.repeatAntiphon(0, 0)).toEqual(true);
  });

  it('should not include repeat antiphons after final set of invitatory if no gloria', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.style = 'invitatory';
    psalm.metadata = {
      antiphon: 'Test antiphon',
      omit_gloria: true,
    };
    expect(psalm.repeatAntiphon(0, 0)).toEqual(false);
  });

  it('should not include repeat antiphons if no antiphons in general', () => {
    const psalm = new Psalm(PSALM_80);
    psalm.style = 'invitatory';
    psalm.metadata = {
      antiphon: 'Test antiphon',
      omit_antiphon: true,
    };
    expect(psalm.repeatAntiphon(0, 0)).toEqual(false);
  });
});
